<?php 
class Login extends My_Controller{
    function index(){
        if(getUserId()){
           	redirect('inicio');
        }
	$datos=[
            'user_id'=>'',
            'perms'=>'',
            'image'=>''
	];
	$this->session->unset_userdata($datos);
        $this->load->view('login');
    }

    function logout() {
        $this->autenticar->logout();
        redirect('login');
    }
    
    function callback(){
        if($this->input->get('code')){
            $this->set_client(GOOGLE_OAUTH_REDIRECT_URI);
            try {
                $this->client->authenticate($this->input->get('code'));
            } catch (Exception $e) {
                log_message('error', 'login.php: '.$e->getMessage());
                redirect();
            }
            $plus = new Google_Service_Plus($this->client);
            $me = $plus->people->get('me');
            $correo=$me['emails'][0]['value'];
            
            if(!$this->autenticar->tryLogin($correo)){
                log_message('debug', 'login.php: no existe el usuario '.$correo);
                $data['correo']=$correo;
                $this->load->view('login', $data);
                return false;
            }
            $this->session->set_userdata('image', strstr($me['image']['url'], '?', true));
            $this->session->set_userdata('url', $me['url']);
            $this->usuarios_model->updateByCorreo($correo, array('acceso'=>date("Y-m-d H:i:s")));
            redirect('tablero');
        }else{
            // No tiene c√≥digo de acceso
            redirect();
        }
    }
}
